{% extends 'main/base.html' %}
{% block title %}Career Compass Sensei{% endblock %}
{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; margin-top: 2rem; min-height: calc(100vh - 200px); max-width: 100%; width: 100%;">
  <!-- Left Column: Input Form -->
  <div class="form-container" style="background: #f8f9fa; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h2 style="margin-top: 0; color: #333;">Career Compass Sensei</h2>
    
    <form id="rec-form">
      <div class="form-group">
        <label for="risk_taking"><strong>Risk Taking</strong></label>
        <select id="risk_taking" name="risk_taking" class="form-control">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>

      <div class="form-group">
        <label for="work_preference"><strong>Work Preference</strong></label>
        <select id="work_preference" name="work_preference" class="form-control">
          <option value="team">Team</option>
          <option value="solo">Solo</option>
          <option value="hybrid">Hybrid</option>
        </select>
      </div>

      <div class="form-group">
        <label for="sentiment"><strong>Sentiment</strong></label>
        <select id="sentiment" name="sentiment" class="form-control">
          <option value="happy">Happy</option>
          <option value="neutral" selected>Neutral</option>
          <option value="stressed">Stressed</option>
        </select>
      </div>

      <div class="form-group">
        <label for="motivation"><strong>Motivation</strong></label>
        <input type="range" id="motivation" name="motivation" min="0" max="100" value="70" class="form-control">
        <div id="motivation-value" style="text-align: center; font-weight: bold;">70%</div>
      </div>

      <div class="form-group">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <label style="margin: 0;"><strong>Your Skills (click to select)</strong></label>
          <button type="button" id="toggle-skills-btn" style="background: #4a6ee0; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">‚ñº Collapse</button>
        </div>
        <div class="skills-grid-expanded" id="skills-grid">
          <div class="skill-card" data-skill="python">Python</div>
          <div class="skill-card" data-skill="java">Java</div>
          <div class="skill-card" data-skill="javascript">JavaScript</div>
          <div class="skill-card" data-skill="typescript">TypeScript</div>
          <div class="skill-card" data-skill="csharp">C#</div>
          <div class="skill-card" data-skill="cpp">C++</div>
          <div class="skill-card" data-skill="go">Go</div>
          <div class="skill-card" data-skill="rust">Rust</div>
          <div class="skill-card" data-skill="php">PHP</div>
          <div class="skill-card" data-skill="ruby">Ruby</div>
          <div class="skill-card" data-skill="swift">Swift</div>
          <div class="skill-card" data-skill="kotlin">Kotlin</div>
          <div class="skill-card" data-skill="r">R</div>
          <div class="skill-card" data-skill="scala">Scala</div>
          <div class="skill-card" data-skill="sql">SQL</div>
          <div class="skill-card" data-skill="nosql">NoSQL</div>
          <div class="skill-card" data-skill="mongodb">MongoDB</div>
          <div class="skill-card" data-skill="postgresql">PostgreSQL</div>
          <div class="skill-card" data-skill="mysql">MySQL</div>
          <div class="skill-card" data-skill="redis">Redis</div>
          <div class="skill-card" data-skill="html">HTML</div>
          <div class="skill-card" data-skill="css">CSS</div>
          <div class="skill-card" data-skill="react">React</div>
          <div class="skill-card" data-skill="angular">Angular</div>
          <div class="skill-card" data-skill="vue">Vue.js</div>
          <div class="skill-card" data-skill="nodejs">Node.js</div>
          <div class="skill-card" data-skill="express">Express.js</div>
          <div class="skill-card" data-skill="django">Django</div>
          <div class="skill-card" data-skill="flask">Flask</div>
          <div class="skill-card" data-skill="spring">Spring Boot</div>
          <div class="skill-card" data-skill="dotnet">.NET</div>
          <div class="skill-card" data-skill="rails">Ruby on Rails</div>
          <div class="skill-card" data-skill="laravel">Laravel</div>
          <div class="skill-card" data-skill="aws">AWS</div>
          <div class="skill-card" data-skill="azure">Azure</div>
          <div class="skill-card" data-skill="gcp">Google Cloud</div>
          <div class="skill-card" data-skill="docker">Docker</div>
          <div class="skill-card" data-skill="kubernetes">Kubernetes</div>
          <div class="skill-card" data-skill="terraform">Terraform</div>
          <div class="skill-card" data-skill="jenkins">Jenkins</div>
          <div class="skill-card" data-skill="gitlab">GitLab CI/CD</div>
          <div class="skill-card" data-skill="github_actions">GitHub Actions</div>
          <div class="skill-card" data-skill="git">Git</div>
          <div class="skill-card" data-skill="linux">Linux</div>
          <div class="skill-card" data-skill="bash">Bash/Shell</div>
          <div class="skill-card" data-skill="powershell">PowerShell</div>
          <div class="skill-card" data-skill="machine_learning">Machine Learning</div>
          <div class="skill-card" data-skill="deep_learning">Deep Learning</div>
          <div class="skill-card" data-skill="tensorflow">TensorFlow</div>
          <div class="skill-card" data-skill="pytorch">PyTorch</div>
          <div class="skill-card" data-skill="scikit_learn">Scikit-Learn</div>
          <div class="skill-card" data-skill="pandas">Pandas</div>
          <div class="skill-card" data-skill="numpy">NumPy</div>
          <div class="skill-card" data-skill="data_analysis">Data Analysis</div>
          <div class="skill-card" data-skill="data_viz">Data Visualization</div>
          <div class="skill-card" data-skill="tableau">Tableau</div>
          <div class="skill-card" data-skill="powerbi">Power BI</div>
          <div class="skill-card" data-skill="excel">Excel</div>
          <div class="skill-card" data-skill="statistics">Statistics</div>
          <div class="skill-card" data-skill="nlp">NLP</div>
          <div class="skill-card" data-skill="computer_vision">Computer Vision</div>
          <div class="skill-card" data-skill="rest_apis">REST APIs</div>
          <div class="skill-card" data-skill="graphql">GraphQL</div>
          <div class="skill-card" data-skill="microservices">Microservices</div>
          <div class="skill-card" data-skill="grpc">gRPC</div>
          <div class="skill-card" data-skill="websockets">WebSockets</div>
          <div class="skill-card" data-skill="testing">Testing/QA</div>
          <div class="skill-card" data-skill="junit">JUnit</div>
          <div class="skill-card" data-skill="pytest">Pytest</div>
          <div class="skill-card" data-skill="selenium">Selenium</div>
          <div class="skill-card" data-skill="cypress">Cypress</div>
          <div class="skill-card" data-skill="devops">DevOps</div>
          <div class="skill-card" data-skill="cicd">CI/CD</div>
          <div class="skill-card" data-skill="agile">Agile/Scrum</div>
          <div class="skill-card" data-skill="jira">Jira</div>
          <div class="skill-card" data-skill="ui_design">UI Design</div>
          <div class="skill-card" data-skill="ux_research">UX Research</div>
          <div class="skill-card" data-skill="figma">Figma</div>
          <div class="skill-card" data-skill="sketch">Sketch</div>
          <div class="skill-card" data-skill="photoshop">Photoshop</div>
          <div class="skill-card" data-skill="illustrator">Illustrator</div>
          <div class="skill-card" data-skill="cybersecurity">Cybersecurity</div>
          <div class="skill-card" data-skill="networking">Networking</div>
          <div class="skill-card" data-skill="blockchain">Blockchain</div>
          <div class="skill-card" data-skill="solidity">Solidity</div>
          <div class="skill-card" data-skill="ethereum">Ethereum</div>
          <div class="skill-card" data-skill="apache_spark">Apache Spark</div>
          <div class="skill-card" data-skill="hadoop">Hadoop</div>
          <div class="skill-card" data-skill="kafka">Apache Kafka</div>
          <div class="skill-card" data-skill="rabbitmq">RabbitMQ</div>
          <div class="skill-card" data-skill="elasticsearch">Elasticsearch</div>
          <div class="skill-card" data-skill="nginx">Nginx</div>
          <div class="skill-card" data-skill="apache">Apache</div>
          <div class="skill-card" data-skill="firebase">Firebase</div>
          <div class="skill-card" data-skill="mongodb_atlas">MongoDB Atlas</div>
          <div class="skill-card" data-skill="supabase">Supabase</div>
          <div class="skill-card" data-skill="problem_solving">Problem Solving</div>
          <div class="skill-card" data-skill="communication">Communication</div>
          <div class="skill-card" data-skill="leadership">Leadership</div>
          <div class="skill-card" data-skill="project_management">Project Management</div>
          <div class="skill-card" data-skill="technical_writing">Technical Writing</div>
          <div class="skill-card" data-skill="public_speaking">Public Speaking</div>
        </div>
      </div>

      <div class="form-group">
        <label><strong>Interest - Data/Programming/Design/Management</strong></label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
          <div>
            <label>Data</label>
            <input type="range" min="1" max="5" value="3" class="interest-slider" data-interest="data">
          </div>
          <div>
            <label>Programming</label>
            <input type="range" min="1" max="5" value="3" class="interest-slider" data-interest="programming">
          </div>
          <div>
            <label>Design</label>
            <input type="range" min="1" max="5" value="3" class="interest-slider" data-interest="design">
          </div>
          <div>
            <label>Management</label>
            <input type="range" min="1" max="5" value="3" class="interest-slider" data-interest="management">
          </div>
        </div>
      </div>

      <button type="submit" class="btn-primary" style="width: 100%; padding: 12px; margin-top: 1rem;">
        Generate Career Insights
      </button>
    </form>
  </div>

  <!-- Right Column: Results -->
  <div class="results-container" style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h2 style="margin-top: 0; color: #333;">Your Career Insights</h2>
    
    <div id="recommendations" class="results-section">
      <h3>Recommended Career Paths</h3>
      <div id="career-paths" class="career-paths">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <!-- Per-role Skill Gap now lives inside each role card -->

    <div id="learning-plan" class="results-section" style="margin-top: 2rem;">
      <h3>Learning Roadmap for Top Role</h3>
      <div id="learning-roadmap" style="background:#f8f9fa; padding:1.5rem; border-radius:8px;">
        <!-- Will be populated dynamically based on top role -->
      </div>
    </div>
  </div>
</div>

<style>
  /* Form Styles */
  .form-container {
    display: flex;
    flex-direction: column;
    max-height: 100%;
    overflow-y: auto;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    margin-top: 0.5rem;
  }
  
  .skills-grid-expanded {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.5rem;
    margin-top: 0.75rem;
  }
  
  .skill-card {
    border: 2px solid #ccc;
    background: #f0f0f0;
    border-radius: 6px;
    padding: 0.6rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-weight: 500;
    font-size: 0.9rem;
  }
  
  .skill-card.selected {
    background: #4a6ee0;
    color: white;
    border-color: #3a5bc7;
  }
  
  .skill-btn {
    padding: 0.5rem;
    border: 1px solid #ccc;
    background: #f0f0f0;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .skill-btn.selected {
    background: #4a6ee0;
    color: white;
    border-color: #3a5bc7;
  }
  
  .btn-primary {
    background: #4a6ee0;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.75rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .btn-primary:hover {
    background: #3a5bc7;
  }
  
  /* Results Styles */
  .results-container {
    display: flex;
    flex-direction: column;
    max-height: 100%;
    overflow-y: auto;
  }

  .results-section {
    margin-bottom: 2rem;
  }
  
  .career-paths {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .career-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem 1rem;
    font-weight: 500;
    cursor: pointer;
  }
  .career-card .role-detail {
    display: none;
    margin-top: 0.75rem;
    border-top: 1px solid #e9ecef;
    padding-top: 0.5rem;
  }
  .career-card .skill-gap-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
  }
  .career-card .skill-gap-grid ul {
    list-style: none;
    padding: 0;
    margin: 0.35rem 0 0 0;
  }
  .career-card .skill-gap-grid li {
    padding: 0.35rem 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .skill-gap-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
  }
  
  .skill-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0 0;
  }
  
  .skill-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #eee;
  }
  
  .learning-plan-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0 0 0;
  }
  
  .learning-plan-list li {
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    border-left: 4px solid #4a6ee0;
  }
  
  /* Slider Styles */
  input[type="range"] {
    width: 100%;
    margin: 0.5rem 0;
  }

  /* Career Demand Visualization */
  .career-demand-viz {
    position: relative;
    height: 140px;
    background: linear-gradient(to bottom, rgba(74,110,224,0.03) 0%, rgba(74,110,224,0.08) 100%);
    border-radius: 8px;
    padding: 1rem;
    overflow: hidden;
  }

  .demand-timeline {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .demand-wave {
    position: absolute;
    top: 20%;
    left: 0;
    right: 0;
    height: 60%;
    background: linear-gradient(90deg, 
      rgba(74,110,224,0.2) 0%,
      rgba(74,110,224,0.4) 25%,
      rgba(74,110,224,0.6) 50%,
      rgba(74,110,224,0.7) 75%,
      rgba(74,110,224,0.85) 100%
    );
    border-radius: 4px;
    animation: demandPulse 3s ease-in-out infinite;
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .career-demand-viz[data-trend="rising"] .demand-wave {
    background: linear-gradient(90deg,
      rgba(40,167,69,0.2) 0%,
      rgba(40,167,69,0.4) 25%,
      rgba(40,167,69,0.6) 50%,
      rgba(40,167,69,0.75) 75%,
      rgba(40,167,69,0.9) 100%
    );
    clip-path: polygon(0% 80%, 20% 70%, 40% 55%, 60% 35%, 80% 20%, 100% 10%,
                       100% 100%, 0% 100%);
  }

  .career-demand-viz[data-trend="falling"] .demand-wave {
    background: linear-gradient(90deg,
      rgba(220,53,69,0.5) 0%,
      rgba(220,53,69,0.4) 25%,
      rgba(220,53,69,0.35) 50%,
      rgba(220,53,69,0.3) 75%,
      rgba(220,53,69,0.2) 100%
    );
    clip-path: polygon(0% 20%, 20% 30%, 40% 45%, 60% 60%, 80% 75%, 100% 85%,
                       100% 100%, 0% 100%);
  }

  .career-demand-viz[data-trend="stable"] .demand-wave {
    background: linear-gradient(90deg,
      rgba(108,117,125,0.4) 0%,
      rgba(108,117,125,0.45) 25%,
      rgba(108,117,125,0.5) 50%,
      rgba(108,117,125,0.45) 75%,
      rgba(108,117,125,0.4) 100%
    );
    clip-path: polygon(0% 50%, 20% 48%, 40% 50%, 60% 49%, 80% 50%, 100% 51%,
                       100% 100%, 0% 100%);
  }

  @keyframes demandPulse {
    0%, 100% { opacity: 0.85; transform: scaleY(1); }
    50% { opacity: 1; transform: scaleY(1.05); }
  }

  .demand-labels {
    display: flex;
    justify-content: space-between;
    margin-top: auto;
    padding-top: 0.5rem;
    font-size: 0.75em;
    color: #666;
    font-weight: 500;
    position: relative;
    z-index: 1;
  }

  .demand-tooltip {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.75);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7em;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 10;
  }

  .career-demand-viz:hover .demand-tooltip {
    opacity: 1;
  }

  .career-demand-viz[data-trend="rising"]:hover .demand-tooltip::after {
    content: "High Demand ‚Äî Growing Market";
  }

  .career-demand-viz[data-trend="falling"]:hover .demand-tooltip::after {
    content: "Declining Demand ‚Äî Contracting Market";
  }

  .career-demand-viz[data-trend="stable"]:hover .demand-tooltip::after {
    content: "Steady Demand ‚Äî Stable Market";
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .form-container, .results-container {
      grid-column: 1 / -1;
    }
    
    .skill-gap-container {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
// Skill selection - simple toggle on click
const selectedSkills = new Set();

document.addEventListener('DOMContentLoaded', function(){
  const skillCards = document.querySelectorAll('.skill-card');
  skillCards.forEach(card => {
    card.addEventListener('click', () => {
      const skill = card.dataset.skill;
      card.classList.toggle('selected');
      if (card.classList.contains('selected')) {
        selectedSkills.add(skill);
      } else {
        selectedSkills.delete(skill);
      }
    });
  });

  // Skills section collapse/expand toggle
  const toggleBtn = document.getElementById('toggle-skills-btn');
  const skillsGrid = document.getElementById('skills-grid');
  let isExpanded = true;

  toggleBtn.addEventListener('click', function(e) {
    e.preventDefault();
    isExpanded = !isExpanded;
    if (isExpanded) {
      skillsGrid.style.display = 'grid';
      toggleBtn.textContent = '‚ñº Collapse';
    } else {
      skillsGrid.style.display = 'none';
      toggleBtn.textContent = '‚ñ∂ Expand';
    }
  });
});

// Update motivation value display
const motivationSlider = document.getElementById('motivation');
const motivationValue = document.getElementById('motivation-value');

motivationSlider.addEventListener('input', (e) => {
  motivationValue.textContent = `${e.target.value}%`;
});

// Handle form submission
document.getElementById('rec-form').addEventListener('submit', async function(e){
  e.preventDefault();
  // Show loading state
  document.getElementById('career-paths').innerHTML = '<p>Analyzing your profile...</p>';
  // Get form values
  const formData = {
    risk_taking: document.getElementById('risk_taking').value,
    work_preference: document.getElementById('work_preference').value,
    sentiment: document.getElementById('sentiment').value,
    motivation: parseInt(motivationSlider.value),
    skills: Array.from(selectedSkills),
    interests: {}
  };
  // Get interest values
  document.querySelectorAll('.interest-slider').forEach(slider => {
    formData.interests[slider.dataset.interest] = parseInt(slider.value);
  });
  try {
    const tokenToName = {
      python: 'Python', java: 'Java', javascript: 'JavaScript', typescript: 'TypeScript', csharp: 'C#', cpp: 'C++', go: 'Go', rust: 'Rust', php: 'PHP', ruby: 'Ruby', swift: 'Swift', kotlin: 'Kotlin', r: 'R', scala: 'Scala',
      sql: 'SQL', nosql: 'NoSQL', mongodb: 'MongoDB', postgresql: 'PostgreSQL', mysql: 'MySQL', redis: 'Redis',
      html: 'HTML', css: 'CSS', react: 'React', angular: 'Angular', vue: 'Vue.js', nodejs: 'Node.js', express: 'Express.js', django: 'Django', flask: 'Flask', spring: 'Spring Boot', dotnet: '.NET', rails: 'Ruby on Rails', laravel: 'Laravel',
      aws: 'AWS', azure: 'Azure', gcp: 'Google Cloud', docker: 'Docker', kubernetes: 'Kubernetes', terraform: 'Terraform', jenkins: 'Jenkins', gitlab: 'GitLab CI/CD', github_actions: 'GitHub Actions',
      git: 'Git', linux: 'Linux', bash: 'Bash/Shell', powershell: 'PowerShell',
      machine_learning: 'Machine Learning', deep_learning: 'Deep Learning', tensorflow: 'TensorFlow', pytorch: 'PyTorch', scikit_learn: 'Scikit-Learn', pandas: 'Pandas', numpy: 'NumPy',
      data_analysis: 'Data Analysis', data_viz: 'Data Visualization', tableau: 'Tableau', powerbi: 'Power BI', excel: 'Excel', statistics: 'Statistics', nlp: 'NLP', computer_vision: 'Computer Vision',
      rest_apis: 'REST APIs', graphql: 'GraphQL', microservices: 'Microservices', grpc: 'gRPC', websockets: 'WebSockets',
      testing: 'Testing/QA', junit: 'JUnit', pytest: 'Pytest', selenium: 'Selenium', cypress: 'Cypress',
      devops: 'DevOps', cicd: 'CI/CD', agile: 'Agile/Scrum', jira: 'Jira',
      ui_design: 'UI Design', ux_research: 'UX Research', figma: 'Figma', sketch: 'Sketch', photoshop: 'Photoshop', illustrator: 'Illustrator',
      cybersecurity: 'Cybersecurity', networking: 'Networking', blockchain: 'Blockchain', solidity: 'Solidity', ethereum: 'Ethereum',
      apache_spark: 'Apache Spark', hadoop: 'Hadoop', kafka: 'Apache Kafka', rabbitmq: 'RabbitMQ', elasticsearch: 'Elasticsearch', nginx: 'Nginx', apache: 'Apache', firebase: 'Firebase', mongodb_atlas: 'MongoDB Atlas', supabase: 'Supabase',
      problem_solving: 'Problem Solving', communication: 'Communication', leadership: 'Leadership', project_management: 'Project Management', technical_writing: 'Technical Writing', public_speaking: 'Public Speaking'
    };
    formData.skills = formData.skills.map(s => tokenToName[s] || s);
    const response = await fetch('{% url "recommend_api" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });
    const data = await response.json();
    updateRecommendationsUI(data);
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('career-paths').innerHTML = `<div class="error">Error: ${error.message}</div>`;
  }
});

// Generate 5-year historical trend bars using job count data
function generateYearlyBars(trend, series) {
  // series should be job counts from backend (e.g., [1200, 1450, 1700, 2100, 2500])
  let values = Array.isArray(series) && series.length >= 5 ? series.slice(-5) : null;

  if (!values) {
    // Fallback: generate estimated job counts if no series provided
    const base = 1500;
    if (trend === 'rising') {
      values = [base, Math.round(base*1.2), Math.round(base*1.4), Math.round(base*1.7), Math.round(base*2.0)];
    } else if (trend === 'falling') {
      values = [base, Math.round(base*0.9), Math.round(base*0.75), Math.round(base*0.6), Math.round(base*0.5)];
    } else {
      values = [base, Math.round(base*1.02), Math.round(base*1.01), Math.round(base*1.03), Math.round(base*1.02)];
    }
  }

  // Find max for scaling bars (use relative heights)
  const maxVal = Math.max(...values);
  const minVal = Math.min(...values);
  const range = maxVal - minVal;

  const color = trend === 'rising' ? '#28a745' : trend === 'falling' ? '#dc3545' : '#6c757d';

  return values.map((jobCount) => {
    // Calculate height as percentage of max (30% min for visibility)
    const heightPct = range > 0 ? 30 + ((jobCount - minVal) / range) * 70 : 60;
    const displayCount = jobCount >= 1000 
      ? `${(jobCount/1000).toFixed(1)}k+` 
      : `${jobCount}+`;
    
    return `
    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
      <div style="width: 100%; background: ${color}; height: ${heightPct}%; min-height: 8px; border-radius: 3px 3px 0 0; transition: height 0.3s; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
        <div style="position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 0.7em; font-weight: 600; color: #333; white-space: nowrap;">${displayCount}</div>
      </div>
    </div>
  `;
  }).join('');
}

// Function to update the UI with recommendations
function updateRecommendationsUI(data) {
  // Update career paths (embed per-role skill gap inside each card)
  const careerPaths = document.getElementById('career-paths');
  const recs = data.recommendations || (data.roles ? data.roles.map(r=>({role:r, score:0.05})) : []);
  const userSkills = Array.from(selectedSkills).map(s=>{
    const tokenToName = {
      python: 'Python', java: 'Java', javascript: 'JavaScript', typescript: 'TypeScript', csharp: 'C#', cpp: 'C++', go: 'Go', rust: 'Rust', php: 'PHP', ruby: 'Ruby', swift: 'Swift', kotlin: 'Kotlin', r: 'R', scala: 'Scala',
      sql: 'SQL', nosql: 'NoSQL', mongodb: 'MongoDB', postgresql: 'PostgreSQL', mysql: 'MySQL', redis: 'Redis',
      html: 'HTML', css: 'CSS', react: 'React', angular: 'Angular', vue: 'Vue.js', nodejs: 'Node.js', express: 'Express.js', django: 'Django', flask: 'Flask', spring: 'Spring Boot', dotnet: '.NET', rails: 'Ruby on Rails', laravel: 'Laravel',
      aws: 'AWS', azure: 'Azure', gcp: 'Google Cloud', docker: 'Docker', kubernetes: 'Kubernetes', terraform: 'Terraform', jenkins: 'Jenkins', gitlab: 'GitLab CI/CD', github_actions: 'GitHub Actions',
      git: 'Git', linux: 'Linux', bash: 'Bash/Shell', powershell: 'PowerShell',
      machine_learning: 'Machine Learning', deep_learning: 'Deep Learning', tensorflow: 'TensorFlow', pytorch: 'PyTorch', scikit_learn: 'Scikit-Learn', pandas: 'Pandas', numpy: 'NumPy',
      data_analysis: 'Data Analysis', data_viz: 'Data Visualization', tableau: 'Tableau', powerbi: 'Power BI', excel: 'Excel', statistics: 'Statistics', nlp: 'NLP', computer_vision: 'Computer Vision',
      rest_apis: 'REST APIs', graphql: 'GraphQL', microservices: 'Microservices', grpc: 'gRPC', websockets: 'WebSockets',
      testing: 'Testing/QA', junit: 'JUnit', pytest: 'Pytest', selenium: 'Selenium', cypress: 'Cypress',
      devops: 'DevOps', cicd: 'CI/CD', agile: 'Agile/Scrum', jira: 'Jira',
      ui_design: 'UI Design', ux_research: 'UX Research', figma: 'Figma', sketch: 'Sketch', photoshop: 'Photoshop', illustrator: 'Illustrator',
      cybersecurity: 'Cybersecurity', networking: 'Networking', blockchain: 'Blockchain', solidity: 'Solidity', ethereum: 'Ethereum',
      apache_spark: 'Apache Spark', hadoop: 'Hadoop', kafka: 'Apache Kafka', rabbitmq: 'RabbitMQ', elasticsearch: 'Elasticsearch', nginx: 'Nginx', apache: 'Apache', firebase: 'Firebase', mongodb_atlas: 'MongoDB Atlas', supabase: 'Supabase',
      problem_solving: 'Problem Solving', communication: 'Communication', leadership: 'Leadership', project_management: 'Project Management', technical_writing: 'Technical Writing', public_speaking: 'Public Speaking'
    };
    return tokenToName[s] || s;
  });

  // Calculate match for all roles and sort by match percentage (descending)
  const allRoles = Object.keys(ROLE_SKILLS);
  const rolesWithMatch = allRoles.map(roleName => {
    const required = ROLE_SKILLS[roleName] || [];
    const youHave = required.filter(r=> userSkills.map(u=>u.toLowerCase()).includes(r.toLowerCase()));
    const missing = required.filter(r=> !youHave.map(u=>u.toLowerCase()).includes(r.toLowerCase()));
    const matchPercent = required.length > 0 ? Math.round((youHave.length / required.length) * 100) : 0;
    const trend = (data.market_trend && data.market_trend[roleName]) || (data.trends && data.trends[roleName]) || 'stable';
    const trendSeries = (data.market_trend_values && data.market_trend_values[roleName]) || null;
    return { roleName, required, youHave, missing, matchPercent, trend, trendSeries };
  });

  // Sort by match percentage (descending) and take top 5
  const top5Roles = rolesWithMatch.sort((a, b) => b.matchPercent - a.matchPercent).slice(0, 5);

  careerPaths.innerHTML = top5Roles.map(role => {
    const trendEmoji = role.trend === 'rising' ? 'üìà' : role.trend === 'falling' ? 'üìâ' : '‚û°Ô∏è';
    const trendColor = role.trend === 'rising' ? '#28a745' : role.trend === 'falling' ? '#dc3545' : '#6c757d';
    const trendText = role.trend === 'rising' ? 'Growing' : role.trend === 'falling' ? 'Declining' : 'Stable';
    const trendWidth = role.trend === 'rising' ? '75%' : role.trend === 'falling' ? '40%' : '60%';
    return `
      <div class="career-card" data-role="${role.roleName}">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>${role.roleName} ${trendEmoji}</div>
        </div>
        <div style="font-size: 0.8em; color: #666;">${role.matchPercent}% match</div>
        <div style="margin-top: 0.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75em; margin-bottom: 0.25rem;">
            <span style="color: ${trendColor}; font-weight: 600;">${trendText} Market</span>
          </div>
          <div style="background: #e9ecef; height: 6px; border-radius: 3px; overflow: hidden;">
            <div style="background: ${trendColor}; height: 100%; width: ${trendWidth}; transition: width 0.3s;"></div>
          </div>
        </div>
        <div class="role-detail">
          <div style="font-weight:600; margin-bottom:0.35rem;">Skill Gap</div>
          <div class="skill-gap-grid">
            <div>
              <div style="font-weight:600;">Required</div>
              <ul>${role.required.map(s=>`<li>${s}</li>`).join('') || '<li>‚Äî</li>'}</ul>
            </div>
            <div>
              <div style="font-weight:600;">You have</div>
              <ul>${role.youHave.map(s=>`<li>${s}</li>`).join('') || '<li>‚Äî</li>'}</ul>
            </div>
            <div>
              <div style="font-weight:600;">Missing</div>
              <ul>${role.missing.map(s=>`<li class="missing-role-skill" data-skill="${s}">${s} <small style="color:#007bff; cursor:pointer;">(learn)</small></li>`).join('') || '<li>‚Äî</li>'}</ul>
              <div class="skill-popup" style="margin-top:6px; display:none;"></div>
            </div>
          </div>
          
          <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
            <div style="font-weight:600; margin-bottom:0.75rem;">5-Year Job Market Growth (Estimated Openings)</div>
            <div style="display: flex; align-items: flex-end; height: 120px; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
              ${generateYearlyBars(role.trend, role.trendSeries)}
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.25rem; font-size: 0.75em; color: #666;">
              <span>2021</span>
              <span>2022</span>
              <span>2023</span>
              <span>2024</span>
              <span>2025</span>
            </div>
          </div>

          <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
            <div style="font-weight:600; margin-bottom:0.75rem;">Career Demand Insights</div>
            <div class="career-demand-viz" data-role="${role.roleName}" data-trend="${role.trend}">
              <div class="demand-timeline">
                <div class="demand-wave"></div>
                <div class="demand-labels">
                  <span>Past</span>
                  <span>Now</span>
                  <span>Future</span>
                </div>
              </div>
              <div class="demand-tooltip"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Update learning roadmap based on top role
  if (top5Roles.length > 0) {
    const topRole = top5Roles[0];
    let roadmapHTML = '';
    
    if (topRole.missing.length > 0) {
      roadmapHTML = `
        <div style="margin-bottom: 1rem;">
          <p style="margin: 0 0 0.75rem 0; color: #666;">
            <strong>To reach higher in ${topRole.roleName}:</strong> Build these ${topRole.missing.length} missing skill(s):
          </p>
          <ul style="list-style: none; padding: 0; margin: 0;">
            ${topRole.missing.map(skill => {
              const url = SKILL_COURSES[skill] || ('https://www.google.com/search?q=' + encodeURIComponent(skill + ' course'));
              return `
                <li style="padding: 0.5rem; background: #fff; border-left: 4px solid #4a6ee0; margin-bottom: 0.5rem; border-radius: 3px;">
                  <a href="${url}" target="_blank" style="color: #4a6ee0; text-decoration: none; font-weight: 500;">üìö ${skill}</a>
                </li>
              `;
            }).join('')}
          </ul>
        </div>
      `;
    } else {
      roadmapHTML = `<p style="color: #28a745;">‚úÖ You have all essential skills for <strong>${topRole.roleName}</strong>!</p>`;
    }
    
    document.getElementById('learning-roadmap').innerHTML = roadmapHTML;
  } else {
    document.getElementById('learning-roadmap').innerHTML = '<p style="color: #999;">Select skills and submit to see learning recommendations.</p>';
  }
}

// Role -> required skills mapping for per-role breakdown
const ROLE_SKILLS = {
  'Software Developer': ['Python','Java','JavaScript','Git','REST APIs','HTML','CSS','SQL','Testing','Problem Solving'],
  'Data Analyst': ['SQL','Python','Excel','Data Visualization','Statistics','Tableau','Power BI','Pandas'],
  'Data Scientist': ['Python','Machine Learning','Statistics','SQL','Data Visualization','Pandas','NumPy','Scikit-Learn','TensorFlow'],
  'Full Stack Developer': ['JavaScript','React','Node.js','CSS','HTML','SQL','MongoDB','Git','REST APIs','Express.js'],
  'Machine Learning Engineer': ['Python','Machine Learning','TensorFlow','PyTorch','Statistics','Data Analysis','Scikit-Learn','Deep Learning'],
  'DevOps Engineer': ['Linux','Docker','Kubernetes','CI/CD','AWS','Terraform','Git','Bash/Shell','Jenkins','Nginx'],
  'Cloud Engineer': ['AWS','Azure','Google Cloud','Terraform','Docker','Kubernetes','Networking','Linux','Python'],
  'Cybersecurity Analyst': ['Networking','Linux','Cybersecurity','Python','Bash/Shell','SQL'],
  'Backend Developer': ['Python','Java','Node.js','SQL','REST APIs','PostgreSQL','MongoDB','Docker','Git'],
  'Frontend Developer': ['JavaScript','React','HTML','CSS','TypeScript','Vue.js','Angular','Git','Figma'],
  'Mobile Developer': ['Swift','Kotlin','React','Java','Android','iOS','Git','REST APIs','Firebase'],
  'Database Administrator': ['SQL','PostgreSQL','MySQL','MongoDB','Redis','Linux','Bash/Shell','Performance Tuning'],
  'Data Engineer': ['Python','SQL','Apache Spark','Kafka','Hadoop','AWS','Docker','Airflow','ETL'],
  'UI/UX Designer': ['UI Design','UX Research','Figma','Sketch','Photoshop','Illustrator','Prototyping','Communication'],
  'Product Manager': ['Agile/Scrum','Jira','Communication','Leadership','Project Management','Problem Solving'],
  'QA Engineer': ['Testing/QA','Selenium','Cypress','JUnit','Pytest','Git','CI/CD','Problem Solving'],
  'Solutions Architect': ['AWS','Azure','Microservices','Docker','Kubernetes','System Design','Leadership','Communication'],
  'Site Reliability Engineer': ['Linux','Kubernetes','Docker','Monitoring','CI/CD','Python','Bash/Shell','AWS'],
  'Blockchain Developer': ['Blockchain','Solidity','Ethereum','JavaScript','Node.js','Git','Smart Contracts'],
  'AI Research Scientist': ['Machine Learning','Deep Learning','Python','TensorFlow','PyTorch','Statistics','NLP','Computer Vision']
};

const SKILL_COURSES = {
  'Python': 'https://www.coursera.org/courses?query=python',
  'Java': 'https://www.coursera.org/courses?query=java',
  'JavaScript': 'https://www.codecademy.com/learn/introduction-to-javascript',
  'TypeScript': 'https://www.typescriptlang.org/docs/',
  'C#': 'https://learn.microsoft.com/en-us/dotnet/csharp/',
  'C++': 'https://www.cplusplus.com/doc/',
  'Go': 'https://go.dev/doc/',
  'Rust': 'https://www.rust-lang.org/what/wasm/',
  'PHP': 'https://www.php.net/docs.php',
  'Ruby': 'https://www.ruby-lang.org/en/documentation/',
  'Swift': 'https://developer.apple.com/swift/',
  'Kotlin': 'https://kotlinlang.org/docs/',
  'R': 'https://www.r-project.org/other-docs.html',
  'Scala': 'https://docs.scala-lang.org/',
  'SQL': 'https://www.khanacademy.org/computing/computer-programming/sql',
  'NoSQL': 'https://www.coursera.org/courses?query=nosql',
  'MongoDB': 'https://docs.mongodb.com/manual/',
  'PostgreSQL': 'https://www.postgresql.org/docs/',
  'MySQL': 'https://dev.mysql.com/doc/',
  'Redis': 'https://redis.io/documentation',
  'HTML': 'https://developer.mozilla.org/en-US/docs/Web/HTML',
  'CSS': 'https://developer.mozilla.org/en-US/docs/Web/CSS',
  'React': 'https://reactjs.org/tutorial/tutorial.html',
  'Angular': 'https://angular.io/docs',
  'Vue.js': 'https://vuejs.org/guide/',
  'Node.js': 'https://nodejs.dev/learn',
  'Express.js': 'https://expressjs.com/',
  'Django': 'https://docs.djangoproject.com/',
  'Flask': 'https://flask.palletsprojects.com/',
  'Spring Boot': 'https://spring.io/projects/spring-boot',
  '.NET': 'https://learn.microsoft.com/en-us/dotnet/',
  'Ruby on Rails': 'https://guides.rubyonrails.org/',
  'Laravel': 'https://laravel.com/docs',
  'AWS': 'https://aws.amazon.com/training/',
  'Azure': 'https://learn.microsoft.com/en-us/azure/',
  'Google Cloud': 'https://cloud.google.com/docs',
  'Docker': 'https://docs.docker.com/get-started/',
  'Kubernetes': 'https://kubernetes.io/docs/tutorials/',
  'Terraform': 'https://www.terraform.io/docs',
  'Jenkins': 'https://www.jenkins.io/doc/',
  'GitLab CI/CD': 'https://docs.gitlab.com/ee/ci/',
  'GitHub Actions': 'https://docs.github.com/en/actions',
  'Git': 'https://www.atlassian.com/git/tutorials',
  'Linux': 'https://www.linux.org/docs/',
  'Bash/Shell': 'https://www.gnu.org/software/bash/manual/',
  'PowerShell': 'https://learn.microsoft.com/en-us/powershell/',
  'Machine Learning': 'https://www.coursera.org/learn/machine-learning',
  'Deep Learning': 'https://www.deeplearning.ai/',
  'TensorFlow': 'https://www.tensorflow.org/learn',
  'PyTorch': 'https://pytorch.org/tutorials/',
  'Scikit-Learn': 'https://scikit-learn.org/stable/user_guide.html',
  'Pandas': 'https://pandas.pydata.org/docs/',
  'NumPy': 'https://numpy.org/doc/',
  'Data Analysis': 'https://www.coursera.org/courses?query=data%20analysis',
  'Data Visualization': 'https://www.coursera.org/courses?query=data%20visualization',
  'Tableau': 'https://www.tableau.com/learn/training',
  'Power BI': 'https://learn.microsoft.com/en-us/power-bi/',
  'Excel': 'https://support.microsoft.com/en-us/excel',
  'Statistics': 'https://www.khanacademy.org/math/statistics-probability',
  'NLP': 'https://www.deeplearning.ai/short-courses/natural-language-processing-specialization/',
  'Computer Vision': 'https://www.deeplearning.ai/short-courses/computer-vision-specialization/',
  'REST APIs': 'https://www.udemy.com/topic/rest-api/',
  'GraphQL': 'https://graphql.org/learn/',
  'Microservices': 'https://www.coursera.org/courses?query=microservices',
  'gRPC': 'https://grpc.io/docs/',
  'WebSockets': 'https://www.html5rocks.com/en/tutorials/websockets/',
  'Testing/QA': 'https://www.coursera.org/courses?query=testing',
  'JUnit': 'https://junit.org/junit5/',
  'Pytest': 'https://docs.pytest.org/',
  'Selenium': 'https://www.selenium.dev/documentation/',
  'Cypress': 'https://docs.cypress.io/',
  'DevOps': 'https://www.coursera.org/courses?query=devops',
  'CI/CD': 'https://www.udemy.com/topic/continuous-integration/',
  'Agile/Scrum': 'https://www.scrum.org/resources/what-is-scrum',
  'Jira': 'https://www.atlassian.com/software/jira/guides',
  'UI Design': 'https://www.udemy.com/topic/ui-design/',
  'UX Research': 'https://www.interaction-design.org/courses',
  'Figma': 'https://help.figma.com/',
  'Sketch': 'https://www.sketch.com/docs/',
  'Photoshop': 'https://helpx.adobe.com/photoshop/user-guide.html',
  'Illustrator': 'https://helpx.adobe.com/illustrator/user-guide.html',
  'Cybersecurity': 'https://www.coursera.org/courses?query=cybersecurity',
  'Networking': 'https://www.cisco.com/learning',
  'Blockchain': 'https://www.coursera.org/courses?query=blockchain',
  'Solidity': 'https://docs.soliditylang.org/',
  'Ethereum': 'https://ethereum.org/en/developers/learning-tools/',
  'Apache Spark': 'https://spark.apache.org/docs/latest/',
  'Hadoop': 'https://hadoop.apache.org/docs/',
  'Apache Kafka': 'https://kafka.apache.org/documentation/',
  'RabbitMQ': 'https://www.rabbitmq.com/documentation.html',
  'Elasticsearch': 'https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html',
  'Nginx': 'https://nginx.org/en/docs/',
  'Apache': 'https://httpd.apache.org/docs/',
  'Firebase': 'https://firebase.google.com/docs',
  'MongoDB Atlas': 'https://docs.atlas.mongodb.com/',
  'Supabase': 'https://supabase.io/docs',
  'Problem Solving': 'https://www.coursera.org/courses?query=problem-solving',
  'Communication': 'https://www.coursera.org/courses?query=communication-skills',
  'Leadership': 'https://www.coursera.org/courses?query=leadership',
  'Project Management': 'https://www.coursera.org/courses?query=project-management',
  'Technical Writing': 'https://developers.google.com/tech-writing',
  'Public Speaking': 'https://www.coursera.org/courses?query=public-speaking',
  'Android': 'https://developer.android.com/docs',
  'iOS': 'https://developer.apple.com/documentation/',
  'Performance Tuning': 'https://www.coursera.org/courses?query=performance-optimization',
  'Airflow': 'https://airflow.apache.org/docs/',
  'ETL': 'https://www.coursera.org/courses?query=etl',
  'Prototyping': 'https://www.interaction-design.org/courses',
  'System Design': 'https://www.educative.io/courses/grokking-the-system-design-interview',
  'Monitoring': 'https://prometheus.io/docs/introduction/overview/',
  'Smart Contracts': 'https://ethereum.org/en/developers/docs/smart-contracts/',
};

// Event delegation: handle card toggle and missing-skill links
document.addEventListener('DOMContentLoaded', function(){
  const careerPaths = document.getElementById('career-paths');
  careerPaths.addEventListener('click', function(e){
    const missingLi = e.target.closest('.missing-role-skill');
    if(missingLi){
      e.stopPropagation();
      const skill = missingLi.dataset.skill;
      const url = SKILL_COURSES[skill] || ('https://www.google.com/search?q=' + encodeURIComponent(skill + ' course'));
      const card = missingLi.closest('.career-card');
      const popup = card.querySelector('.skill-popup');
      popup.innerHTML = `<a target="_blank" href="${url}">Open learning resources for ${skill}</a>`;
      popup.style.display = 'block';
      return;
    }

    const card = e.target.closest('.career-card');
    if(card){
      const detail = card.querySelector('.role-detail');
      if(!detail) return;
      const isHidden = detail.style.display === 'none' || detail.style.display === '';
      document.querySelectorAll('#career-paths .role-detail').forEach(d=>{ d.style.display = 'none'; });
      detail.style.display = isHidden ? 'block' : 'none';
    }
  });
});

// Initialize with some default data for demo
window.addEventListener('DOMContentLoaded', () => {
  // Simulate a click on some skills
  const defaultSkills = ['python', 'java', 'javascript', 'sql'];
  defaultSkills.forEach(skill => {
    const card = document.querySelector(`.skill-card[data-skill="${skill}"]`);
    if (card) {
      card.click(); // Toggle to selected state
    }
  });
});
</script>
{% endblock %}
