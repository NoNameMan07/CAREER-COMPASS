{% extends 'main/base.html' %}
{% block title %}Career Compass Sensei{% endblock %}
{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
  <!-- Left Column: Input Form -->
  <div class="form-container" style="background: #f8f9fa; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h2 style="margin-top: 0; color: #333;">Career Compass Sensei</h2>
    
    <form id="rec-form">
      <div class="form-group">
        <label for="risk_taking"><strong>Risk Taking</strong></label>
        <select id="risk_taking" name="risk_taking" class="form-control">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>

      <div class="form-group">
        <label for="work_preference"><strong>Work Preference</strong></label>
        <select id="work_preference" name="work_preference" class="form-control">
          <option value="team">Team</option>
          <option value="solo">Solo</option>
          <option value="hybrid">Hybrid</option>
        </select>
      </div>

      <div class="form-group">
        <label for="sentiment"><strong>Sentiment</strong></label>
        <select id="sentiment" name="sentiment" class="form-control">
          <option value="happy">Happy</option>
          <option value="neutral" selected>Neutral</option>
          <option value="stressed">Stressed</option>
        </select>
      </div>

      <div class="form-group">
        <label for="motivation"><strong>Motivation</strong></label>
        <input type="range" id="motivation" name="motivation" min="0" max="100" value="70" class="form-control">
        <div id="motivation-value" style="text-align: center; font-weight: bold;">70%</div>
      </div>

      <div class="form-group">
        <label><strong>Top Skills (toggle)</strong></label>
        <div class="skills-grid">
          <button type="button" class="skill-btn" data-skill="python">Python</button>
          <button type="button" class="skill-btn" data-skill="java">Java</button>
          <button type="button" class="skill-btn" data-skill="sql">SQL</button>
          <button type="button" class="skill-btn" data-skill="javascript">JavaScript</button>
          <button type="button" class="skill-btn" data-skill="data_viz">Data Visualization</button>
          <button type="button" class="skill-btn" data-skill="statistics">Statistics</button>
          <button type="button" class="skill-btn" data-skill="cloud">Cloud</button>
          <button type="button" class="skill-btn" data-skill="aws">AWS</button>
          <button type="button" class="skill-btn" data-skill="devops">DevOps</button>
          <button type="button" class="skill-btn" data-skill="docker">Docker</button>
          <button type="button" class="skill-btn" data-skill="cybersecurity">Cybersecurity</button>
          <button type="button" class="skill-btn" data-skill="ux_research">UX Research</button>
          <button type="button" class="skill-btn" data-skill="ui_design">UI Design</button>
          <button type="button" class="skill-btn" data-skill="problem_solving">Problem Solving</button>
          <button type="button" class="skill-btn" data-skill="communication">Communication</button>
        </div>
      </div>

      <div class="form-group">
        <label><strong>Interest - Data/Programming/Design/Management</strong></label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
          <div>
            <label>Data</label>
            <input type="range" min="1" max="5" value="3" class="interest-slider" data-interest="data">
          </div>
          <div>
            <label>Programming</label>
            <input type="range" min="1" max="5" value="3" class="interest-slider" data-interest="programming">
          </div>
          <div>
            <label>Design</label>
            <input type="range" min="1" max="5" value="3" class="interest-slider" data-interest="design">
          </div>
          <div>
            <label>Management</label>
            <input type="range" min="1" max="5" value="3" class="interest-slider" data-interest="management">
          </div>
        </div>
      </div>

      <button type="submit" class="btn-primary" style="width: 100%; padding: 12px; margin-top: 1rem;">
        Generate Career Insights
      </button>
    </form>
  </div>

  <!-- Right Column: Results -->
  <div class="results-container" style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h2 style="margin-top: 0; color: #333;">Your Career Insights</h2>
    
    <div id="recommendations" class="results-section">
      <h3>Recommended Career Paths</h3>
      <div id="career-paths" class="career-paths">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <div id="learning-plan" class="results-section" style="margin-top: 2rem;">
      <h3>Learning Plan</h3>
      <ul id="learning-plan-list" class="learning-plan-list">
        <!-- Will be populated by JavaScript -->
      </ul>
    </div>

    <div id="emotion-trend" class="results-section" style="margin-top: 2rem;">
      <h3>Emotion & Market Trend</h3>
      <div id="emotion-market-info">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<style>
  /* Form Styles */
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    margin-top: 0.5rem;
  }
  
  .skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .skill-btn {
    padding: 0.5rem;
    border: 1px solid #ccc;
    background: #f0f0f0;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .skill-btn.selected {
    background: #4a6ee0;
    color: white;
    border-color: #3a5bc7;
  }
  
  .btn-primary {
    background: #4a6ee0;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.75rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .btn-primary:hover {
    background: #3a5bc7;
  }
  
  /* Results Styles */
  .results-section {
    margin-bottom: 2rem;
  }
  
  .career-paths {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .career-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem 1rem;
    font-weight: 500;
    cursor: pointer;
  }

  .career-card .role-detail {
    margin-top: 0.75rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e9ecef;
    display: none;
  }

  .career-card .role-detail .skill-gap-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
  }

  .career-card .role-detail ul {
    list-style: none;
    padding: 0;
    margin: 0.35rem 0 0 0;
  }

  .career-card .role-detail li {
    padding: 0.35rem 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .skill-gap-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
  }
  
  .skill-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0 0;
  }
  
  .skill-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #eee;
  }
  
  .learning-plan-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0 0 0;
  }
  
  .learning-plan-list li {
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    border-left: 4px solid #4a6ee0;
  }
  
  /* Slider Styles */
  input[type="range"] {
    width: 100%;
    margin: 0.5rem 0;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .form-container, .results-container {
      grid-column: 1 / -1;
    }
    
    .skill-gap-container {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
// Skill selection
const skillButtons = document.querySelectorAll('.skill-btn');
const selectedSkills = new Set();

skillButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const skill = btn.dataset.skill;
    btn.classList.toggle('selected');
    
    if (btn.classList.contains('selected')) {
      selectedSkills.add(skill);
    } else {
      selectedSkills.delete(skill);
    }
  });
});

// Update motivation value display
const motivationSlider = document.getElementById('motivation');
const motivationValue = document.getElementById('motivation-value');

motivationSlider.addEventListener('input', (e) => {
  motivationValue.textContent = `${e.target.value}%`;
});

// Handle form submission
document.getElementById('rec-form').addEventListener('submit', async function(e){
  e.preventDefault();
  // Show loading state
  document.getElementById('career-paths').innerHTML = '<p>Analyzing your profile...</p>';
  // Get form values
  const formData = {
    risk_taking: document.getElementById('risk_taking').value,
    work_preference: document.getElementById('work_preference').value,
    sentiment: document.getElementById('sentiment').value,
    motivation: parseInt(motivationSlider.value),
    skills: Array.from(selectedSkills),
    interests: {}
  };
  // Get interest values
  document.querySelectorAll('.interest-slider').forEach(slider => {
    formData.interests[slider.dataset.interest] = parseInt(slider.value);
  });
  try {
    const tokenToName = {
      python: 'Python',
      java: 'Java',
      javascript: 'JavaScript',
      sql: 'SQL',
      data_viz: 'Tableau',
      statistics: 'Statistics',
      cloud: 'AWS',
      aws: 'AWS',
      devops: 'DevOps',
      docker: 'Docker',
      cybersecurity: 'Cybersecurity',
      ux_research: 'User Research',
      ui_design: 'UI Design',
      problem_solving: 'Problem Solving',
      communication: 'Communication'
    };
    formData.skills = formData.skills.map(s => tokenToName[s] || s);
    const response = await fetch('{% url "recommend_api" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });
    const data = await response.json();
    updateRecommendationsUI(data);
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('career-paths').innerHTML = `<div class="error">Error: ${error.message}</div>`;
  }
});

// Function to update the UI with recommendations
function updateRecommendationsUI(data) {
  // Update career paths (merged with per-role skill gap inside each card)
  const careerPaths = document.getElementById('career-paths');
  // Ensure we have recommendations array (backwards-compatible with earlier API)
  const recs = data.recommendations || (data.roles ? data.roles.map(r=>({role:r, score:0.05})) : []);
  const userSkills = Array.from(selectedSkills).map(s=>{
    const tokenToName = {
      python: 'Python',
      java: 'Java',
      javascript: 'JavaScript',
      sql: 'SQL',
      data_viz: 'Tableau',
      statistics: 'Statistics',
      cloud: 'AWS',
      aws: 'AWS',
      devops: 'DevOps',
      docker: 'Docker',
      cybersecurity: 'Cybersecurity',
      ux_research: 'User Research',
      ui_design: 'UI Design',
      problem_solving: 'Problem Solving',
      communication: 'Communication'
    };
    return tokenToName[s] || s;
  });

  careerPaths.innerHTML = recs.map(rec => {
    const roleName = rec.role || rec;
    const trend = (data.market_trend && data.market_trend[roleName]) || (data.trends && data.trends[roleName]) || 'stable';
    const trendEmoji = trend === 'rising' ? 'üìà' : trend === 'falling' ? 'üìâ' : '‚û°Ô∏è';
    const scorePct = rec.score ? Math.round(rec.score * 100) : (data.roles ? Math.round((data.roles.indexOf(roleName)+1)/Math.max(1,data.roles.length)*100) : 5);
    const required = ROLE_SKILLS[roleName] || [];
    const youHave = required.filter(r=> userSkills.map(u=>u.toLowerCase()).includes(r.toLowerCase()));
    const missing = required.filter(r=> !youHave.map(u=>u.toLowerCase()).includes(r.toLowerCase()));
    return `
      <div class="career-card" data-role="${roleName}">
        <div>${roleName} ${trendEmoji}</div>
        <div style="font-size: 0.8em; color: #666;">${scorePct}% match</div>
        <div class="role-detail" data-role="${roleName}">
          <div style="font-weight:600; margin-bottom:0.35rem;">Skill Gap</div>
          <div class="skill-gap-grid">
            <div>
              <div style="font-weight:600;">Required</div>
              <ul>${required.map(s=>`<li>${s}</li>`).join('') || '<li>‚Äî</li>'}</ul>
            </div>
            <div>
              <div style="font-weight:600;">You have</div>
              <ul>${youHave.map(s=>`<li>${s}</li>`).join('') || '<li>‚Äî</li>'}</ul>
            </div>
            <div>
              <div style="font-weight:600;">Missing</div>
              <ul>${missing.map(s=>`<li class="missing-role-skill" data-skill="${s}">${s} <small style="color:#007bff; cursor:pointer;">(learn)</small></li>`).join('') || '<li>‚Äî</li>'}</ul>
              <div class="skill-popup" style="margin-top:6px;"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Update learning plan
  document.getElementById('learning-plan-list').innerHTML = data.learning_plan
    .map(item => `
      <li>
        <strong>${item.skill}</strong> - ${item.course} (${item.source}, ${item.weeks} weeks)
      </li>
    `).join('');
  
  // Update emotion & market trend
  const s = data.emotion.sentiment || {pos:0.33, neu:0.33, neg:0.33};
  const sentimentEmoji = (s.pos || 0) > 0.5 ? 'üòä' : (s.neg || 0) > 0.5 ? 'üòü' : 'üòê';
  
  const marketTrends = Object.entries(data.market_trend)
    .map(([role, trend]) => {
      const trendIcon = trend === 'rising' ? 'üìà' : trend === 'falling' ? 'üìâ' : '‚û°Ô∏è';
      return `${role} ${trendIcon}`;
    })
    .join(', ');
  
  document.getElementById('emotion-market-info').innerHTML = `
    <p>Current Motivation: ${data.emotion.motivation_score}% ${sentimentEmoji}</p>
    <p>Sentiment ‚Üí pos ${(Math.round((s.pos||0)*100))}%, neu ${(Math.round((s.neu||0)*100))}%, neg ${(Math.round((s.neg||0)*100))}%</p>
    <p>Market Trends: ${marketTrends}</p>
  `;
}

// Role -> required skills mapping for per-role breakdown (used when clicking a career card)
const ROLE_SKILLS = {
  'Software Developer': ['Python','Java','JavaScript','Git','REST APIs'],
  'Data Analyst': ['SQL','Python','Excel','Data Visualization','Statistics'],
  'Data Scientist': ['Python','Machine Learning','Statistics','SQL','Data Visualization'],
  'Full Stack Developer': ['JavaScript','React','Node.js','CSS','Databases'],
  'Machine Learning Engineer': ['Python','Machine Learning','TensorFlow','Data Pipelines','Statistics'],
  'DevOps Engineer': ['Linux','Docker','Kubernetes','CI/CD','Cloud'],
  'Cloud Engineer': ['AWS','Terraform','Docker','Networking','Linux'],
  'Cybersecurity Analyst': ['Networking','Linux','Security Principles','SIEM','Python'],
};

const SKILL_COURSES = {
  'Python': 'https://www.coursera.org/courses?query=python',
  'Java': 'https://www.coursera.org/courses?query=java',
  'JavaScript': 'https://www.codecademy.com/learn/introduction-to-javascript',
  'Git': 'https://www.atlassian.com/git/tutorials',
  'REST APIs': 'https://www.udemy.com/topic/rest-api/',
  'SQL': 'https://www.khanacademy.org/computing/computer-programming/sql',
  'Machine Learning': 'https://www.coursera.org/learn/machine-learning',
  'Data Visualization': 'https://www.coursera.org/courses?query=data%20visualization',
  'TensorFlow': 'https://www.tensorflow.org/learn',
  'Docker': 'https://docs.docker.com/get-started/',
  'Kubernetes': 'https://kubernetes.io/docs/tutorials/',
  'AWS': 'https://aws.amazon.com/training/',
  'React': 'https://reactjs.org/tutorial/tutorial.html',
  'Node.js': 'https://nodejs.dev/learn',
};

// Attach click handlers to career cards after they are rendered
function attachCareerCardHandlers(){
  document.querySelectorAll('.career-card').forEach(card=>{
    card.addEventListener('click', ()=>{
      const detail = card.querySelector('.role-detail');
      if(!detail) return;
      const isHidden = detail.style.display === 'none' || detail.style.display === '';
      // Close others
      document.querySelectorAll('.role-detail').forEach(d=>{ d.style.display = 'none'; });
      detail.style.display = isHidden ? 'block' : 'none';
    });

    // Missing skill -> course link popup
    card.querySelectorAll('.missing-role-skill').forEach(li=>{
      li.addEventListener('click', function(e){
        e.stopPropagation();
        const skill = this.dataset.skill;
        const url = SKILL_COURSES[skill] || ('https://www.google.com/search?q=' + encodeURIComponent(skill + ' course'));
        const popup = this.parentElement.querySelector('.skill-popup');
        if(!popup) return;
        popup.innerHTML = `<a target=\"_blank\" href=\"${url}\">Open learning resources for ${skill}</a>`;
        popup.style.display = 'block';
      });
    });
  });
}

// Ensure handlers run after DOM updates
const observer = new MutationObserver((mutations)=>{ attachCareerCardHandlers(); });
observer.observe(document.getElementById('career-paths'), { childList: true, subtree: true });

// Initialize with some default data for demo
window.addEventListener('DOMContentLoaded', () => {
  // Simulate a click on some skills
  const defaultSkills = ['python', 'java', 'javascript', 'sql'];
  defaultSkills.forEach(skill => {
    const btn = document.querySelector(`.skill-btn[data-skill="${skill}"]`);
    if (btn) {
      btn.click(); // Toggle to selected state
    }
  });
});
</script>
{% endblock %}